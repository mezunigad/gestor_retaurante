<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epicuro - Reportería de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --epicuro-primary: #2C3E50;
            --epicuro-secondary: #E74C3C;
            --epicuro-accent: #3498DB;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--epicuro-primary);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--epicuro-primary);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .metric-card {
            text-align: center;
            padding: 15px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--epicuro-secondary);
        }
        
        .metric-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        .btn-epicuro {
            background-color: var(--epicuro-secondary);
            color: white;
        }
        
        .btn-epicuro:hover {
            background-color: #c0392b;
            color: white;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-title {
            color: var(--epicuro-primary);
            margin-bottom: 20px;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 10px;
        }
        
        .header-title {
            margin: 0;
            color: #333;
            font-size: 2em;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            color: #dc3545;
            text-align: center;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="/static/logo.png" alt="Epicuro Logo" height="30"> Epicuro - Reportería
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Inicio</a>
                <a class="nav-link" href="/products">Productos</a>
                <a class="nav-link" href="/orders">Nueva Comanda</a>
                <a class="nav-link" href="/orders/list">Comandas</a>
                <a class="nav-link active" href="/reports">Reportes</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="logo-container">
            <img src="/static/logo.png" alt="Logo Epicuro" class="logo">
            <h1 class="header-title">Dashboard de Ventas</h1>
        </div>
        
        <!-- Filtros -->
        <div class="row filter-section">
            <div class="col-md-3">
                <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" id="fechaInicio">
            </div>
            <div class="col-md-3">
                <label for="fechaFin" class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" id="fechaFin">
            </div>
            <div class="col-md-3">
                <label for="categoria" class="form-label">Categoría</label>
                <select class="form-select" id="categoria">
                    <option value="">Todas</option>
                    <option value="SANDWICH">SANDWICH</option>
                    <option value="COMPLETO">COMPLETO</option>
                    <option value="BEBIDA">BEBIDA</option>
                    <option value="ENERGÉTICA">ENERGÉTICA</option>
                    <option value="JUGO">JUGO</option>
                    <option value="CAFETERÍA">CAFETERÍA</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="vendedor" class="form-label">Vendedor</label>
                <select class="form-select" id="vendedor">
                    <option value="">Todos</option>
                    <!-- Se cargarán dinámicamente -->
                </select>
            </div>
            <div class="col-md-12 mt-3">
                <button class="btn btn-epicuro" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button class="btn btn-outline-secondary" onclick="exportarPDF()">Exportar PDF</button>
                <button class="btn btn-outline-secondary" onclick="exportarExcel()">Exportar Excel</button>
                <button class="btn btn-outline-secondary" onclick="actualizarTodo()">Actualizar</button>
            </div>
        </div>
        
        <!-- Métricas principales -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="ventasTotales">$0</div>
                    <div class="metric-label">VENTAS TOTALES</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalPedidos">0</div>
                    <div class="metric-label">PEDIDOS</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="ticketPromedio">$0</div>
                    <div class="metric-label">TICKET PROMEDIO</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="margenBeneficio">0%</div>
                    <div class="metric-label">MARGEN DE BENEFICIO</div>
                </div>
            </div>
        </div>
        
        <!-- Gráficos -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        Tendencia de Ventas
                    </div>
                    <div class="card-body">
                        <canvas id="ventasChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Ventas por Categoría
                    </div>
                    <div class="card-body">
                        <canvas id="categoriasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Top 5 Productos
                    </div>
                    <div class="card-body">
                        <canvas id="productosChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Ventas por Día de la Semana
                    </div>
                    <div class="card-body">
                        <canvas id="diasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabla de detalle -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Detalle de Ventas</span>
                        <input type="text" class="form-control form-control-sm w-25" placeholder="Buscar..." id="searchInput" onkeyup="filtrarTabla()">
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tablaVentas">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Producto</th>
                                        <th>Categoría</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Total</th>
                                        <th>Costo</th>
                                        <th>Beneficio</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaVentasBody">
                                    <tr>
                                        <td colspan="10" class="loading">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            Cargando datos...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para almacenar datos y gráficos
        let datosVentas = [];
        let ventasChartInstance = null;
        let categoriasChartInstance = null;
        let productosChartInstance = null;
        let diasChartInstance = null;
        
        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            configurarFechasPorDefecto();
            actualizarTodo();
        });
        
        function configurarFechasPorDefecto() {
            // Establecer fecha de inicio (hace 30 días) y fecha fin (hoy)
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            // Formatear fechas para input type="date" (YYYY-MM-DD)
            document.getElementById('fechaInicio').value = hace30Dias.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
        }
        
        function actualizarTodo() {
            actualizarMetricas();
            crearGraficoTendenciaVentas();
            crearGraficoVentasPorCategoria();
            crearGraficoTopProductos();
            crearGraficoVentasPorDia();
            cargarDatosVentas();
        }
        
        async function cargarDatosVentas() {
            try {
                // Obtener fechas para filtros
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                const categoria = document.getElementById('categoria').value;
                
                // Construir URL con parámetros
                let url = '/api/ventas';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                if (categoria) params.append('categoria', categoria);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Mostrar indicador de carga
                document.getElementById('tablaVentasBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Cargando datos...
                        </td>
                    </tr>
                `;
                
                // Hacer la solicitud a la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                datosVentas = await response.json();
                actualizarTabla(datosVentas);
            } catch (error) {
                console.error("Error cargando datos de ventas:", error);
                document.getElementById('tablaVentasBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="error">
                            <i class="bi bi-exclamation-triangle"></i> Error al cargar los datos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        async function actualizarMetricas() {
            try {
                // Obtener parámetros de filtro
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                const categoria = document.getElementById('categoria').value;
                
                // Construir URL
                let url = '/api/metricas';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                if (categoria) params.append('categoria', categoria);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Obtener datos de la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const metricas = await response.json();
                
                // Actualizar UI
                document.getElementById('ventasTotales').textContent = `$${metricas.ventas_totales.toLocaleString('es-CL')}`;
                document.getElementById('totalPedidos').textContent = metricas.total_pedidos.toLocaleString('es-CL');
                document.getElementById('ticketPromedio').textContent = `$${Math.round(metricas.ticket_promedio).toLocaleString('es-CL')}`;
                document.getElementById('margenBeneficio').textContent = `${metricas.margen_beneficio.toFixed(2)}%`;
            } catch (error) {
                console.error("Error actualizando métricas:", error);
                document.getElementById('ventasTotales').textContent = '$0';
                document.getElementById('totalPedidos').textContent = '0';
                document.getElementById('ticketPromedio').textContent = '$0';
                document.getElementById('margenBeneficio').textContent = '0%';
            }
        }
        
        async function crearGraficoTendenciaVentas() {
            try {
                const ctx = document.getElementById('ventasChart').getContext('2d');
                
                // Obtener parámetros de filtro
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                // Construir URL
                let url = '/api/ventas-por-dia';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Obtener datos de la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const ventasPorDia = await response.json();
                
                // Preparar datos para el gráfico
                const fechas = ventasPorDia.map(item => item.fecha);
                const montos = ventasPorDia.map(item => item.ventas_totales);
                
                // Destruir instancia anterior si existe
                if (ventasChartInstance) {
                    ventasChartInstance.destroy();
                }
                
                // Crear nuevo gráfico
                ventasChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: fechas,
                        datasets: [{
                            label: 'Ventas por Día',
                            data: montos,
                            borderColor: '#E74C3C',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evolución de Ventas Diarias'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Ventas: $${context.raw.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `$${value.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creando gráfico de tendencia:", error);
                document.getElementById('ventasChart').innerHTML = '<p class="error">Error al cargar el gráfico</p>';
            }
        }
        
        async function crearGraficoVentasPorCategoria() {
            try {
                const ctx = document.getElementById('categoriasChart').getContext('2d');
                
                // Obtener parámetros de filtro
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                // Construir URL
                let url = '/api/ventas-por-categoria';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Obtener datos de la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const categoriasData = await response.json();
                
                // Preparar datos para el gráfico
                const categorias = categoriasData.map(item => item.categoria);
                const montos = categoriasData.map(item => item.ventas_totales);
                
                // Destruir instancia anterior si existe
                if (categoriasChartInstance) {
                    categoriasChartInstance.destroy();
                }
                
                // Colores para las categorías
                const colores = [
                    '#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6', '#1ABC9C', '#34495E'
                ];
                
                // Crear nuevo gráfico
                categoriasChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categorias,
                        datasets: [{
                            data: montos,
                            backgroundColor: colores,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: $${value.toLocaleString('es-CL')} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creando gráfico de categorías:", error);
                document.getElementById('categoriasChart').innerHTML = '<p class="error">Error al cargar el gráfico</p>';
            }
        }
        
        async function crearGraficoTopProductos() {
            try {
                const ctx = document.getElementById('productosChart').getContext('2d');
                
                // Obtener parámetros de filtro
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                // Construir URL
                let url = '/api/top-productos';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Obtener datos de la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const productosData = await response.json();
                
                // Preparar datos para el gráfico
                const productos = productosData.map(item => item.producto);
                const montos = productosData.map(item => item.ventas_totales);
                
                // Destruir instancia anterior si existe
                if (productosChartInstance) {
                    productosChartInstance.destroy();
                }
                
                // Crear nuevo gráfico
                productosChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: productos,
                        datasets: [{
                            label: 'Ventas',
                            data: montos,
                            backgroundColor: '#3498DB',
                            borderColor: '#2980B9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Productos Más Vendidos por Valor'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Ventas: $${context.raw.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `$${value.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creando gráfico de productos:", error);
                document.getElementById('productosChart').innerHTML = '<p class="error">Error al cargar el gráfico</p>';
            }
        }
        
        async function crearGraficoVentasPorDia() {
            try {
                const ctx = document.getElementById('diasChart').getContext('2d');
                
                // Obtener parámetros de filtro
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                // Construir URL
                let url = '/api/ventas-por-dia-semana';
                const params = new URLSearchParams();
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                // Obtener datos de la API
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const diasData = await response.json();
                
                // Preparar datos para el gráfico
                const dias = diasData.map(item => item.dia_semana);
                const montos = diasData.map(item => item.ventas_totales);
                
                // Destruir instancia anterior si existe
                if (diasChartInstance) {
                    diasChartInstance.destroy();
                }
                
                // Crear nuevo gráfico
                diasChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dias,
                        datasets: [{
                            label: 'Ventas',
                            data: montos,
                            backgroundColor: '#2ECC71',
                            borderColor: '#27AE60',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ventas por Día de la Semana'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Ventas: $${context.raw.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `$${value.toLocaleString('es-CL')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error creando gráfico de días:", error);
                document.getElementById('diasChart').innerHTML = '<p class="error">Error al cargar el gráfico</p>';
            }
        }
        
        function actualizarTabla(datos) {
            const tablaBody = document.getElementById('tablaVentasBody');
            tablaBody.innerHTML = '';
            
            if (datos.length === 0) {
                tablaBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="loading">
                            No hay datos para mostrar con los filtros seleccionados
                        </td>
                    </tr>
                `;
                return;
            }
            
            datos.forEach(item => {
                const beneficio = item.total - item.costo;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.idPedido}</td>
                    <td>${item.fecha.split('T')[0]}</td>
                    <td>${item.cliente}</td>
                    <td>${item.producto}</td>
                    <td>${item.categoria}</td>
                    <td>${item.cantidad}</td>
                    <td>$${item.precio.toLocaleString('es-CL')}</td>
                    <td>$${item.total.toLocaleString('es-CL')}</td>
                    <td>$${item.costo.toLocaleString('es-CL')}</td>
                    <td class="${beneficio >= 0 ? 'text-success' : 'text-danger'}">$${beneficio.toLocaleString('es-CL')}</td>
                `;
                tablaBody.appendChild(row);
            });
        }
        
        function aplicarFiltros() {
            actualizarTodo();
        }
        
        function filtrarTabla() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('tablaVentas');
            const tr = table.getElementsByTagName('tr');
            
            // Empezar desde 1 para saltar el encabezado
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                
                tr[i].style.display = found ? '' : 'none';
            }
        }
        
        function exportarPDF() {
            alert('Funcionalidad de exportación a PDF. En una implementación real, se generaría un PDF con el reporte.');
        }
        
        function exportarExcel() {
            alert('Funcionalidad de exportación a Excel. En una implementación real, se exportarían los datos a Excel.');
        }
    </script>
</body>
</html>